
# Access to MQTT with MSX0 IoT BASIC
## 概要
MSX0の IoT BASICから MQTTのサーバ（ブローカ）に接続してpublish/subscribeを行います。
動作はmosquitto-2.0のサーバ（ブローカ）にて確認しています。パスワード認証は実装しましたが証明書等による認証は実装していません。
以下の説明はMQTT自体についてはある程度ご理解頂いている前提で書いています。

### 制限
色々な部分で128文字以上のデータを想定していません。トピックやメッセージは短めにする必要があります。延長するにはMQTTプロトコル自体の知識が必要です。

## コード
mqttsamp.bas
https://gist.github.com/nyasu3w/b4dcefd0e432ae6f19e4babb1e6d3ff4

行番号999まではサンプルコードです。行番号1000以降にあるサブルーチンを呼んで使います。
行番号10のSRV$や行番号20,30のTP$などは環境に合わせて変更する必要があります。

## 使い方
### connect
まず最初にブローカにconnectする必要があります。
変数SRV$にMQTTブローカのアドレスを入れてGOSUB 1000してください。ポート番号は1883でハードコードしてあります。変更する場合は行番号1025を編集してください。

パスワード認証を行う場合は、1016行、1017行のコメントを外した上で、1016行のUR$(ユーザ名)とPW$(パスワード)を変更してください。

### publish
connectした状態で変数TP$にトピック、変数ME$にメッセージを入れてGOSUB 1100してください。

### subscribe
実際にメッセージを受け取るには待ちが入るのでちょっとややこしくなります。
変数TP$にトピックを入れてGOSUB 1200してください。これでトピックの購読が出来ます。複数回呼べます。

そして、購読したトピックのデータを実際に受信するには、GOSUB 1900します。MQTTのパケットを1つ読んで変数RV$に入れて戻ります。publishされたパケット以外の場合は捨てる必要があります。行番号50はそのためのif文です。

次に読み取ったRV$から自力でトピックとメッセージを取り出します。大したことありません。
行番号55の後半のMID$()でトピックを取り出しています。行番号65のMID$()でメッセージを取り出しています。参考にしてください。

### disconnect
ちゃんとdisconnectしたい場合はGOSUB 1500してください。まあ忘れててもサーバが勝手に終わらせてしまうでしょう。現状は設定値127秒の5割増しでタイムアウトします。

### pingreq
何もしないとタイムアウトしてしまう場合、これを送りつけてタイムアウトさせないようにします。でも今はsubscribeのpacket readがブロックしてしまうため使い所がありません。packet readの1915行の直前あたりに何か仕込む必要があるでしょう。

## 動作例
サンプルでは貰ったデータをPRINTしていますが、メッセージを整数にして背景色設定した動作が https://twitter.com/nyasu3w2022/status/1725166350945935786
（なお、コメントのcolor文は誤りで、COLOR  ,VAL(...) AND &HF が正しいです）
